<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.tailwindcss.com"></script>

	<style>
    @import "tailwindcss";
		#view-game {
		  background-image: url('/src/image.png');
		  background-size: cover;
		  background-position: center;
		  background-repeat: no-repeat;
		  height: 100vh; /* prend tout l'Ã©cran */
		  display: none; /* par dÃ©faut masquÃ© */
		}
      .perspective {
        perspective: 1000px;
      }
      
      .card-3d {
        transform-style: preserve-3d;
        transition: transform 0.8s ease;
      }
      
      .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 1rem;
      }
      
      .backface-hidden {
        backface-visibility: hidden;
      }
      
      .rotate-y-180 {
        transform: rotateY(180deg);
      }
      .metal-effect {
    background: linear-gradient(135deg, #cfcfcf, #8f8f8f);
    background-blend-mode: overlay;
    box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.4),
                inset 0 0 30px rgba(0, 0, 0, 0.2),
                0 4px 20px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  .flipped {
  transform: rotateY(180deg);
}
.online {
  background-color: #22c55e; /* vert Tailwind 500 */
}

.offline {
  background-color: #ef4444; /* rouge Tailwind 500 */
}

      </style>
       
  <meta charset="UTF-8">
  <title>Pong</title>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
  <nav>
    <div id="nav-public">
      <button onclick="showOnly('view-register')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">CrÃ©er un compte</button>
      <button onclick="showOnly('view-login')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Se connecter</button>
    </div>
  
    <div id="nav-user" class="hidden space-x-4 items-center">
      <button id="nav-home" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" onclick="showOnly('view-home')">Accueil</button>
      <button id="nav-game-online" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded" onclick="showOnly('view-home')">Jouer en ligne</button>
      <button id="nav-game" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded" onclick="showOnly('view-game')">Jouer en local</button>
      <span id="nav-displayname" class="font-semibold"></span>
      <button onclick="openSettings()" class="text-sm underline text-blue-600">ParamÃ¨tres</button>
      <button onclick="logout()" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600">Se dÃ©connecter</button>
    </div>
  </nav>
  

  <div id="messageBox"></div>

  <div id="view-home" class="p-8 text-center">
    <h1 class="text-4xl font-bold text-blue-700 mb-2">Bienvenue sur Pong</h1>
    <p class="text-lg">Cliquer sur "Jouer" pour commencer.</p>
  </div>

  <div id="view-game" class="flex justify-center items-center">
    <canvas id="gameCanvas" width="800" height="600" class="rounded-lg shadow-lg"></canvas>
  </div>

  <div id="view-register" class="hidden p-8 max-w-md mx-auto bg-white rounded shadow mt-8 space-y-4">
    <h2 class="text-2xl font-semibold text-center text-gray-700">CrÃ©er un utilisateur</h2>
    <input id="first_name" type="text" placeholder="PrÃ©nom" class="w-full border px-3 py-2 rounded">
    <input id="last_name" type="text" placeholder="Nom" class="w-full border px-3 py-2 rounded">
    <input id="username" type="text" placeholder="Nom d'utilisateur" class="w-full border px-3 py-2 rounded">
    <input id="password" type="password" placeholder="Mot de passe" class="w-full border px-3 py-2 rounded">
    <input id="email" type="email" placeholder="Email" class="w-full border px-3 py-2 rounded">
    <input id="display_name" type="text" placeholder="Nom de jeu" class="w-full border px-3 py-2 rounded">
    <button onclick="sendUser()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded w-full">Envoyer</button>
    <pre id="logUser" class="text-sm text-red-600"></pre>
  </div>

  <div id="view-login" class="hidden p-8 max-w-md mx-auto bg-white rounded shadow mt-8 space-y-4">
    <h2 class="text-2xl font-semibold text-center text-gray-700">Connexion</h2>
    <input id="login_email" type="email" placeholder="Email" class="w-full border px-3 py-2 rounded">
    <input id="login_password" type="password" placeholder="Mot de passe" class="w-full border px-3 py-2 rounded">
    <button onclick="loginUser()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded w-full">Se connecter</button>
    <pre id="logLogin" class="text-sm text-red-600"></pre>
  </div>

  <div id="view-settings" class="hidden p-8 max-w-md mx-auto bg-white rounded shadow mt-8 space-y-4">
    <h2 class="text-2xl font-semibold text-center text-gray-700">ParamÃ¨tres</h2>
<div class="flex justify-center gap-4">
  <button onclick="showSettingsSubView('view-profile'); loadProfile()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Voir mon profil</button>
<button onclick="showSettingsSubView('view-edit-settings')" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Changer mes infos</button>

</div>

  <div id="view-edit-settings" class="space-y-4 mt-6">
  <!-- tes champs param_first_name, param_last_name... -->
    <input id="param_first_name" type="text" placeholder="PrÃ©nom" class="w-full border px-3 py-2 rounded">
    <input id="param_last_name" type="text" placeholder="Nom" class="w-full border px-3 py-2 rounded">
    <input id="param_email" type="email" placeholder="Email" class="w-full border px-3 py-2 rounded">
    <input id="param_display_name" type="text" placeholder="Nom de jeu" class="w-full border px-3 py-2 rounded">
    <input id="param_avatar_url" type="text" placeholder="Lien avatar (URL)" class="w-full border px-3 py-2 rounded">
    <button onclick="updateUser()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded w-full">Enregistrer</button>
    <pre id="logUpdateUser" class="text-sm text-green-600"></pre>
  </div>
  
  <div id="view-profile" class="hidden flex justify-center mt-12 perspective">
    <div class="card-3d w-[350px] h-[220px] relative cursor-pointer">
      
      <!-- Face avant -->
      <div class="card-face card-front metal-effect bg-gradient-to-br from-gray-300 to-gray-500 text-white p-6 rounded-xl shadow-xl absolute inset-0 backface-hidden">
        <div id="profile_status" class="absolute top-3 right-3 w-4 h-4 rounded-full border-2 border-white shadow-lg bg-gray-400"></div>
        <img id="profile_avatar" src="/default.png" alt="Avatar" class="w-16 h-16 rounded-full border-2 border-white mb-3">
        <h2 id="profile_display_name" class="text-xl font-bold"></h2>
        <p id="profile_email" class="text-sm text-white/80 mb-2"></p>
        <div class="text-sm space-y-1">
          <p><span class="text-yellow-300">ğŸ† Victoires :</span> <span id="profile_wins">0</span></p>
          <p><span class="text-red-300">âŒ DÃ©faites :</span> <span id="profile_losses">0</span></p>
        </div>
      </div>
  
      <!-- Face arriÃ¨re -->
      <div class="card-face card-back metal-effect bg-gray-800 text-white p-6 rounded-xl shadow-xl absolute inset-0 backface-hidden rotate-y-180">
        <div class="space-y-2 text-sm">
          <p><strong>ğŸ‘¤ PrÃ©nom :</strong> <span id="profile_first_name">-</span></p>
          <p><strong>ğŸ§‘ Nom :</strong> <span id="profile_last_name">-</span></p>
          <p><strong>ğŸ“… CrÃ©Ã© le :</strong> <span id="profile_created_at">-</span></p>
          <p><strong>ğŸ•’ DerniÃ¨re connexion :</strong> <span id="profile_last_seen">-</span></p>
          <p><strong>ğŸ” Username :</strong> <span id="profile_username">-</span></p>
        </div>
      </div>
  
    </div>
  </div>

  <script >

function toggleRegister() {
      showOnly('view-register');
    }

    function sendUser() {
      const data = {
        first_name: document.getElementById('first_name').value,
        last_name: document.getElementById('last_name').value,
        username: document.getElementById('username').value,
        password: document.getElementById('password').value,
        email: document.getElementById('email').value,
        display_name: document.getElementById('display_name').value
      };

      fetch('/sign-up', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(async res => {
          if (!res.ok) {
            const text = await res.text();
            throw new Error(Erreur `HTTP ${res.status} : ${text}`);
          }
          return res.json();
        })
        .then(json => {
          setLoggedInUser(json);
          document.getElementById('logUser').textContent = JSON.stringify(json, null, 2);
          document.getElementById('view-register').style.display = 'none';
        })
        .catch(err => {
          document.getElementById('logUser').textContent = 'Erreur : ' + err.message;
        });
		document.getElementById('first_name').value = '';
	document.getElementById('last_name').value = '';
	document.getElementById('username').value = '';
	document.getElementById('password').value = '';
	document.getElementById('email').value = '';
	document.getElementById('display_name').value = '';

    }

    function setLoggedInUser(user) {
      localStorage.setItem('user', JSON.stringify(user));
      document.getElementById('nav-public').style.display = 'none';
      document.getElementById('nav-user').style.display = 'block';
      document.getElementById('nav-displayname').textContent = `ğŸ‘¤ ${user.display_name}`;
    }

    function logout() {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user) return;

  fetch('/logout', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id: user.id })
  })
  .then(() => {
    localStorage.removeItem('user');
    document.getElementById('nav-public').style.display = 'block';
    document.getElementById('nav-user').style.display = 'none';
    document.getElementById('nav-displayname').textContent = '';
    showOnly('view-home');
  })
  .catch(err => {
    console.error("Erreur de dÃ©connexion :", err);
    // MÃªme en cas d'erreur, on force la dÃ©connexion locale
    localStorage.removeItem('user');
    showOnly('view-home');
  });
}


    // ğŸ” Au chargement de la page : afficher nav-user si dÃ©jÃ  connectÃ©
    window.addEventListener('DOMContentLoaded', () => {
      const savedUser = localStorage.getItem('user');
      if (savedUser) {
        const user = JSON.parse(savedUser);
        setLoggedInUser(user);
      }
    });

	function toggleLogin() {
    showOnly('view-login');
}

function loginUser() {
  const data = {
    email: document.getElementById('login_email').value,
    password: document.getElementById('login_password').value
  };

  fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
    .then(async res => {
      if (!res.ok) {
        const text = await res.text();
        throw new Error(Erreur `HTTP ${res.status} : ${text}`);
      }
      return res.json();
    })
    .then(user => {
      setLoggedInUser(user);
      document.getElementById('view-login').style.display = 'none';
      document.getElementById('logLogin').textContent = '';
    })
    .catch(err => {
      document.getElementById('logLogin').textContent = 'Erreur : ' + err.message;
    });
}

function openSettings() {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user) return;

  document.getElementById('param_first_name').value = user.first_name || '';
  document.getElementById('param_last_name').value = user.last_name || '';
  document.getElementById('param_email').value = user.email || '';
  document.getElementById('param_display_name').value = user.display_name || '';
  document.getElementById('param_avatar_url').value = user.avatar_url || '';

  showOnly('view-settings');
}


function updateUser() {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user) return;

  const data = {
    first_name: document.getElementById('param_first_name').value,
    last_name: document.getElementById('param_last_name').value,
    email: document.getElementById('param_email').value,
    display_name: document.getElementById('param_display_name').value,
    avatar_url: document.getElementById('param_avatar_url').value

  };

  fetch(`/users/${user.id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
    .then(async res => {
      if (!res.ok) {
        const text = await res.text();
        throw new Error(Erreur `HTTP ${res.status} : ${text}`);
      }
      return res.json();
    })
    .then(updatedUser => {
      localStorage.setItem('user', JSON.stringify(updatedUser));
      document.getElementById('logUpdateUser').textContent = 'âœ… Modifications enregistrÃ©es.';
      setLoggedInUser(updatedUser); // met Ã  jour l'affichage du nom
    })
    .catch(err => {
      document.getElementById('logUpdateUser').textContent = 'Erreur : ' + err.message;
    });
}

function showLocalGame() {
  showOnly('view-game');
}

function showOnly(viewId) {
  const views = [
    'view-home',
    'view-game',
    'view-register',
    'view-login',
    'view-settings',
    'view-edit-settings',
    'view-profile'
  ];
  views.forEach(id => {
    document.getElementById(id).style.display = (id === viewId) ? 'block' : 'none';
  });
}

function showSettingsSubView(subViewId) {
  const subViews = ['view-edit-settings', 'view-profile'];
  subViews.forEach(id => {
    document.getElementById(id).style.display = (id === subViewId) ? 'block' : 'none';
  });
}


function formatDate(isoString) {
  if (!isoString) return 'non dÃ©fini';
  const date = new Date(isoString);
  return date.toLocaleDateString('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function loadProfile() {
  const stored = JSON.parse(localStorage.getItem('user'));
  if (!stored) return;

  fetch(`/users/${stored.id}`)
    .then(res => {
      if (!res.ok) throw new Error('Impossible de charger le profil');
      return res.json();
    })
    
    .then(user => {
  const statusIndicator = document.getElementById('profile_status');
  if (user.is_online) {
  statusIndicator.classList.remove('offline', 'bg-gray-400');
  statusIndicator.classList.add('online');
} else {
  statusIndicator.classList.remove('online', 'bg-gray-400');
  statusIndicator.classList.add('offline');
}


  document.getElementById('profile_avatar').src = user.avatar_url || '/default.png';
  document.getElementById('profile_display_name').innerText = user.display_name || '';
  document.getElementById('profile_email').innerText = user.email || '';
  document.getElementById('profile_username').innerText = user.username || '';
  document.getElementById('profile_first_name').innerText = user.first_name || '';
  document.getElementById('profile_last_name').innerText = user.last_name || '';
  document.getElementById('profile_created_at').innerText = formatDate(user.created_at);
  document.getElementById('profile_last_seen').innerText = formatDate(user.last_seen);
  document.getElementById('profile_wins').innerText = user.wins ?? 0;
  document.getElementById('profile_losses').innerText = user.losses ?? 0;
  })
    .catch(err => {
      console.error('Erreur profil :', err);
    });
}


document.addEventListener('DOMContentLoaded', () => {
  const card = document.querySelector('.card-3d');
  if (!card) return;

  card.addEventListener('click', () => {
    card.classList.toggle('flipped');
  });
});
  </script>
  <script type="module" src="/src/main.ts"></script>
</body>
</html>

